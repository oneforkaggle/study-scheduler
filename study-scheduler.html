<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Study Scheduler – Live v2</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>
  :root{
    --bg:#0b0d12; --card:#121622; --muted:#98a2b3; --text:#e6e9ef; --accent:#6ea8fe; --accent2:#7dd3fc; --border:#1e2433; --good:#34d399; --warn:#fbbf24;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif; background:var(--bg); color:var(--text)}
  .container{max-width:1250px; margin:0 auto; padding:20px}
  h1{margin:0 0 12px}
  .btn{cursor:pointer; border:1px solid var(--border); background:#0f1321; color:#fff; border-radius:10px; padding:8px 12px}
  .btn:hover{border-color:#2b3347}
  .btn.primary{background:linear-gradient(135deg, var(--accent), var(--accent2)); color:#081220; font-weight:700; border:none}
  .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.3)}
  .muted{color:var(--muted)}
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:16px}
  .grid3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
  .row{display:flex; gap:16px; align-items:stretch}
  .col{flex:1}
  .header{display:flex; justify-content:space-between; align-items:center; gap:8px}
  .table-head{display:grid; grid-template-columns:100px 1fr 1fr 1fr; gap:8px; font-weight:600; opacity:.8; border-bottom:1px solid var(--border); padding-bottom:6px; margin-bottom:6px}
  .table-row{display:grid; grid-template-columns:100px 1fr 1fr 1fr; gap:8px; align-items:start; padding:8px 0; border-top:1px dashed var(--border)}
  textarea, input[type="text"], input[type="time"], input[type="date"], select{
    background:#0e1220; color:var(--text); border:1px solid var(--border); border-radius:8px; padding:6px 8px; width:100%;
  }
  .chip{font-size:12px; opacity:.8; border:1px solid #28304a; padding:2px 6px; border-radius:999px; margin-right:6px}
  .badge{display:inline-flex; align-items:center; gap:6px; border:1px solid var(--border); padding:2px 8px; border-radius:999px; font-weight:700}
  .badge.accent{border-color:transparent; background:linear-gradient(135deg, var(--accent), var(--accent2)); color:#081220}
  .daystrip{display:flex; gap:8px; overflow-x:auto; scroll-snap-type:x mandatory; padding-bottom:6px}
  .day{min-width:200px; scroll-snap-align:center; border:1px solid var(--border); border-radius:12px; padding:10px; background:#0f1321; cursor:pointer; position:relative}
  .day.active{outline:2px solid var(--accent)}
  .day .title{display:flex; justify-content:space-between; align-items:center}
  .tasks{list-style:none; padding:0; margin:8px 0 0 0; display:flex; flex-direction:column; gap:6px}
  .task{display:flex; align-items:center; gap:6px; font-size:13px}
  .task .dot{width:8px; height:8px; border-radius:50%; background:#6ea8fe; display:inline-block}
  .task.done{opacity:.5; text-decoration:line-through}
  .inline-input{margin-top:8px}
  .rowBetween{display:flex; justify-content:space-between; align-items:center; border:1px solid var(--border); border-radius:12px; padding:10px; background:#0f1321; margin-bottom:8px; flex-wrap:wrap; gap:8px}
  .wrap{white-space:normal; word-break:break-word; overflow-wrap:anywhere}
  .due-left{flex:1; min-width:0}
  .due-line{display:flex; align-items:flex-start; gap:8px; flex-wrap:wrap}
  .due-label{display:inline-flex; align-items:flex-start; gap:6px; max-width:100%}
  .due-label .wrap{white-space:normal; overflow-wrap:anywhere}
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:50}
  .modal .panel{background:#111726; border:1px solid var(--border); border-radius:12px; padding:16px; width:min(520px, 92vw)}
  .kbd{border:1px solid var(--border); padding:1px 6px; border-radius:6px; background:#0e1220; font-size:12px}
  .pill{display:inline-flex; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#0f1321; gap:8px; align-items:center}
  @media (max-width: 1100px){ .grid2{grid-template-columns:1fr} .table-head,.table-row{grid-template-columns:100px 1fr} }
</style>
</head>
<body>
<div class="container">
  <h1>📚 Study Scheduler – Live v2</h1>

  <div class="grid2">
    <div class="card" id="thisWeek"></div>
    <div class="card" id="nextWeek"></div>
  </div>

  <!-- Controls between weeks and strip -->
  <div class="card" style="margin-top:16px" id="controlsBar">
    <div class="header">
      <div style="display:flex; gap:8px; align-items:center">
        <label>跳轉到日期</label>
        <input type="date" id="jumpDate"/>
        <button class="btn" id="jumpBtn">Go</button>
        <span class="muted">或直接左右滑動日條</span>
      </div>
      <div style="display:flex; gap:8px; align-items:center">
        <button class="btn" id="openQuickAdd">+ Add Task</button>
        <button class="btn" id="openRecurring">⚙︎ Recurring Schedule</button>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:16px" id="stripCard"></div>

  <!-- Countdown columns -->
  <div class="grid3" style="margin-top:16px">
    <div class="card" id="duePast"></div>
    <div class="card" id="dueNext7"></div>
    <div class="card" id="dueFar"></div>
  </div>

  <!-- Day Planner below countdown -->
  <div class="card" style="margin-top:16px" id="planner"></div>
</div>

<!-- Modal: Time-block -->
<div class="modal" id="modalTB">
  <div class="panel">
    <h3 style="margin-top:0">新增時間區段任務</h3>
    <div class="grid3">
      <div>
        <label>日期</label>
        <input type="date" id="tbDate" disabled>
      </div>
      <div>
        <label>開始</label>
        <input type="time" id="tbStart" value="09:00" step="60">
      </div>
      <div>
        <label>結束</label>
        <input type="time" id="tbEnd" value="10:00" step="60">
      </div>
    </div>
    <div class="grid3" style="margin-top:8px">
      <div>
        <label>科目</label>
        <select id="tbSubject"></select>
      </div>
      <div>
        <label>類型</label>
        <select id="tbType">
          <option>Task</option><option>Preview</option><option>Review</option><option>Homework</option><option>Exam</option><option>Class</option>
        </select>
      </div>
      <div>
        <label>加入倒數</label><br/>
        <label style="display:inline-flex; align-items:center; gap:6px"><input type="checkbox" id="tbCountdownChk"> 包含於倒數</label>
      </div>
    </div>
    <div style="margin-top:8px">
      <label>內容</label>
      <input type="text" id="tbText" placeholder="要做什麼？">
    </div>
    <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end">
      <button class="btn" id="tbCancel">取消</button>
      <button class="btn primary" id="tbSave">儲存</button>
    </div>
  </div>
</div>

<!-- Modal: Recurring -->
<div class="modal" id="modalRecurring">
  <div class="panel">
    <h3 style="margin-top:0">固定課表（每週重複）</h3>
    <div class="muted" style="margin-bottom:6px">新增你每週固定的上課時段（會自動顯示在日條）。</div>
    <div id="recList"></div>
    <div style="margin-top:8px; display:grid; grid-template-columns:1fr 1fr 1fr 1fr 1fr; gap:8px">
      <select id="recWeekday">
        <option value="0">Sun</option><option value="1">Mon</option><option value="2">Tue</option><option value="3">Wed</option><option value="4">Thu</option><option value="5">Fri</option><option value="6">Sat</option>
      </select>
      <select id="recSubject"></select>
      <input type="time" id="recStart" value="09:00" step="60">
      <input type="time" id="recEnd" value="10:00" step="60">
      <button class="btn" id="recAdd">+ Add</button>
    </div>
    <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end">
      <button class="btn" id="recClose">關閉</button>
    </div>
  </div>
</div>

<!-- Modal: Quick Add -->
<div class="modal" id="modalQuick">
  <div class="panel">
    <h3 style="margin-top:0">快速新增任務（必選日期，不需時間段）</h3>
    <div class="grid3">
      <div>
        <label>日期</label>
        <input type="date" id="qaDate">
      </div>
      <div>
        <label>科目</label>
        <select id="qaSubject"></select>
      </div>
      <div>
        <label>加入倒數</label><br/>
        <label style="display:inline-flex; align-items:center; gap:6px"><input type="checkbox" id="qaCountdownChk"> 包含於倒數</label>
      </div>
    </div>
    <div style="margin-top:8px">
      <label>類型</label>
      <select id="qaType">
        <option>Task</option><option>Preview</option><option>Review</option><option>Homework</option><option>Exam</option><option>Class</option>
      </select>
    </div>
    <div style="margin-top:8px">
      <label>內容</label>
      <input type="text" id="qaText" placeholder="要做什麼？">
    </div>
    <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end">
      <button class="btn" id="qaCancel">取消</button>
      <button class="btn primary" id="qaSave">儲存</button>
    </div>
  </div>
</div>

<script>
// --- Utils & constants ---
const SUBJECTS = ['Biology','Biochem','English','Physics','Chemistry'];
const ABBR = { Biology:'B', Biochem:'BC', English:'E', Physics:'P', Chemistry:'C' };
const KEY='study-scheduler-live-v2';
const DAY=86400000;
const startOfDay = d=>{ const x=new Date(d); x.setHours(0,0,0,0); return x };
const addDays = (d,n)=> new Date(startOfDay(d).getTime()+n*DAY);
const weekStartOf = d=> addDays(startOfDay(d), -startOfDay(d).getDay()); // Sun-based week
const dateKey = d => { const x=startOfDay(d); const y=x.getFullYear(); const m=String(x.getMonth()+1).padStart(2,'0'); const dd=String(x.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}` };
const iso = d=> startOfDay(d).toISOString();
const fmtMD = d=> `${d.getMonth()+1}/${d.getDate()}`;

// --- Store ---
let store = load() || {
  weekNotes: [],  // {id, weekStartISO, subject, lessons:[{id,text,reviews[3],reviewTs[3]}], homework:[{id,text,done}], exams:[{id,text,done}]}
  dayPlans: {},   // { 'YYYY-MM-DD': [{id,start?,end?,text,subject,type,done, includeInCountdown}] }
  pinnedDateISO: iso(new Date()),
  baseOffset: 0,
  recurring: [],  // [{id, weekday(0-6), subject, start, end}]
};
save();
function load(){ try{ return JSON.parse(localStorage.getItem(KEY)) }catch{return null} }
function save(){ localStorage.setItem(KEY, JSON.stringify(store)) }

function ensureNote(weekStartISO, subject){
  let n = store.weekNotes.find(x=> x.weekStartISO===weekStartISO && x.subject===subject);
  if(!n){ n = { id: (crypto.randomUUID? crypto.randomUUID(): String(Math.random()).slice(2)), weekStartISO, subject, taught:'', homework:[], exams:[], lessons:[] }; store.weekNotes.push(n); save(); }
  return n;
}
function weekStartFromBase(offset=0){ return addDays(weekStartOf(new Date()), (store.baseOffset + offset)*7) }

// --- Weeks table ---
function renderWeekBlock(el, title, startDate){
  const endDate = addDays(startDate,6);
  const startISO = iso(startOfDay(startDate));
  const head = `
    <div class="header">
      <h3 style="margin:0">${title} · ${fmtMD(startDate)} - ${fmtMD(endDate)}</h3>
      <div style="display:flex; gap:8px">
        <button class="btn" data-shift="-1">◀ Prev</button>
        <button class="btn" data-shift="1">Next ▶</button>
      </div>
    </div>
    <div class="table-head">
      <div>Subject</div><div>Lesson Content</div><div>Homework</div><div>Exams</div>
    </div>
  `;

  const rows = SUBJECTS.map(sub=>{
    const n = ensureNote(startISO, sub);
    // 單一筆模式
    if(!n.lessons || n.lessons.length===0){ n.lessons=[{ id:(crypto.randomUUID? crypto.randomUUID(): String(Math.random()).slice(2)), text:'', reviews:[false,false,false], reviewTs:[null,null,null] }]; }
    if(!n.homework || n.homework.length===0){ n.homework=[{ id:(crypto.randomUUID? crypto.randomUUID(): String(Math.random()).slice(2)), text:'', done:false }]; }
    if(!n.exams || n.exams.length===0){ n.exams=[{ id:(crypto.randomUUID? crypto.randomUUID(): String(Math.random()).slice(2)), text:'', done:false }]; }
    const ls=n.lessons[0]; const hw=n.homework[0]; const ex=n.exams[0];

    return `
      <div class="table-row">
        <div style="font-weight:700; letter-spacing:.3px">${ABBR[sub]||sub}</div>
        <div>
          <div style="border:1px solid var(--border); border-radius:10px; padding:8px; margin-bottom:6px">
            <textarea rows="2" class="wrap" placeholder="What was taught this week?" data-bind="lesson-text" data-id="${ls.id}" data-sub="${sub}" data-week="${startISO}">${ls.text||''}</textarea>
            <div style="display:flex; gap:12px; margin-top:8px; align-items:center; flex-wrap:wrap">
              ${[0,1,2].map(i=>{
                const checked = ls.reviews?.[i] ? 'checked' : '';
                const label = `R${i+1}`;
                return `
                  <label style="display:inline-flex; align-items:center; gap:6px">
                    <input type="checkbox" data-bind="lesson-review" data-id="${ls.id}" data-i="${i}" data-sub="${sub}" data-week="${startISO}" ${checked}/>
                    <span style="opacity:.8; font-size:12px">${label}</span>
                  </label>
                `;
              }).join('')}
            </div>
          </div>
        </div>
        <div>
          <div style="display:flex; gap:6px; align-items:flex-start; margin-bottom:6px">
            <input type="checkbox" data-bind="hw-done" data-id="${hw.id}" data-sub="${sub}" data-week="${startISO}" ${hw.done?'checked':''}/>
            <textarea class="wrap" rows="2" placeholder="Homework" data-bind="hw-text" data-id="${hw.id}" data-sub="${sub}" data-week="${startISO}">${hw.text||''}</textarea>
          </div>
        </div>
        <div>
          <div style="display:flex; gap:6px; align-items:flex-start; margin-bottom:6px">
            <input type="checkbox" data-bind="ex-done" data-id="${ex.id}" data-sub="${sub}" data-week="${startISO}" ${ex.done?'checked':''}/>
            <textarea class="wrap" rows="2" placeholder="Exam / Quiz" data-bind="ex-text" data-id="${ex.id}" data-sub="${sub}" data-week="${startISO}">${ex.text||''}</textarea>
          </div>
        </div>
      </div>
    `;
  }).join('');

  el.innerHTML = head + rows;

  el.querySelectorAll('[data-shift]').forEach(btn=>{
    btn.addEventListener('click', ()=>{ store.baseOffset += Number(btn.getAttribute('data-shift')); save(); renderAll(); });
  });

  const getNote = (week, sub)=> ensureNote(week, sub);

  // 綁定 Lesson/HW/EX 欄位（單筆）
  el.querySelectorAll('[data-bind="lesson-text"]').forEach(inp=> inp.oninput = ()=>{
    const {sub, week} = inp.dataset; const id=inp.getAttribute('data-id');
    const n=getNote(week, sub); n.lessons = n.lessons.map(x=> x.id===id? ({...x, text: inp.value}): x); save();
  });
  el.querySelectorAll('[data-bind="lesson-review"]').forEach(chk=> chk.onchange = ()=>{
    const {sub, week} = chk.dataset; const id=chk.getAttribute('data-id'); const i=Number(chk.getAttribute('data-i'));
    const n=getNote(week, sub);
    n.lessons = n.lessons.map(x=>{
      if(x.id!==id) return x;
      const reviews=(x.reviews||[false,false,false]).slice(); const reviewTs=(x.reviewTs||[null,null,null]).slice();
      reviews[i]=chk.checked; reviewTs[i]= chk.checked? new Date().toISOString(): null;
      return {...x, reviews, reviewTs}
    }); save(); renderAll();
  });
  el.querySelectorAll('[data-bind="hw-text"]').forEach(inp=> inp.oninput = ()=>{
    const {sub, week} = inp.dataset; const id=inp.getAttribute('data-id');
    const n=getNote(week, sub); n.homework = [ { ...(n.homework[0]||{}), id, text: inp.value, done: n.homework[0]?.done||false } ]; save();
  });
  el.querySelectorAll('[data-bind="hw-done"]').forEach(chk=> chk.onchange = ()=>{
    const {sub, week} = chk.dataset; const id=chk.getAttribute('data-id');
    const n=getNote(week, sub); n.homework = [ { ...(n.homework[0]||{}), id, done: chk.checked, text: n.homework[0]?.text||'' } ]; save(); renderAll();
  });
  el.querySelectorAll('[data-bind="ex-text"]').forEach(inp=> inp.oninput = ()=>{
    const {sub, week} = inp.dataset; const id=inp.getAttribute('data-id');
    const n=getNote(week, sub); n.exams = [ { ...(n.exams[0]||{}), id, text: inp.value, done: n.exams[0]?.done||false } ]; save();
  });
  el.querySelectorAll('[data-bind="ex-done"]').forEach(chk=> chk.onchange = ()=>{
    const {sub, week} = chk.dataset; const id=chk.getAttribute('data-id');
    const n=getNote(week, sub); n.exams = [ { ...(n.exams[0]||{}), id, done: chk.checked, text: n.exams[0]?.text||'' } ]; save(); renderAll();
  });
}

// --- Day strip ---
let stripRange = { start: addDays(new Date(), -14), end: addDays(new Date(), +14) };
function ensureDayArrayHas(date){
  const margin = 5;
  if(date < addDays(stripRange.start, margin)){ stripRange.start = addDays(stripRange.start, -14); }
  if(date > addDays(stripRange.end, -margin)){ stripRange.end = addDays(stripRange.end, +14); }
}
function getAllDayItemsFor(date){ const key=dateKey(date); return (store.dayPlans[key]||[]).filter(x=> !x.start && !x.end) }
function getTimedItemsFor(date){ const key=dateKey(date); return (store.dayPlans[key]||[]).filter(x=> x.start && x.end) }
function getRecurringFor(date){ const wd = startOfDay(date).getDay(); return (store.recurring||[]).filter(r=> r.weekday===wd).map(r=> ({...r, isRecurringGenerated:true})) }

function buildStrip(container){
  const pinned = startOfDay(new Date(store.pinnedDateISO));
  ensureDayArrayHas(pinned);
  const days = []; for(let d=new Date(stripRange.start); d<=stripRange.end; d=addDays(d,1)) days.push(new Date(d));

  const title = `
    <div class="header">
      <div style="display:flex; gap:8px; align-items:center">
        <h3 style="margin:0">連續日條（點一下快速輸入／雙擊新增時間區段）</h3>
      </div>
      <div style="display:flex; gap:8px; align-items:center">
        <button class="btn" id="dayPrev">◀ Day</button>
        <button class="btn" id="dayNext">Day ▶</button>
        <button class="btn" id="dayToday">Today</button>
        <span class="muted">Selected: ${pinned.toLocaleDateString()}</span>
      </div>
    </div>
  `;
  const todayKey = dateKey(new Date());
  const pinnedKey = dateKey(pinned);

  const cards = days.map(d=>{
    const key = dateKey(d);
    const selected = key===pinnedKey;

    const dueItems = (()=>{ const arr=[];
      for(const n of store.weekNotes){
        (n.homework||[]).forEach(h=>{ if(!h.done && h.dueISO && h.dueISO.slice(0,10)===key) arr.push({kind:'HW', sub:n.subject, text:h.text}) });
        (n.exams||[]).forEach(e=>{ if(!e.done && e.dueISO && e.dueISO.slice(0,10)===key) arr.push({kind:'EX', sub:n.subject, text:e.text}) });
      }
      const plans = store.dayPlans[key]||[];
      plans.forEach(p=>{ if(p.includeInCountdown && !p.done) arr.push({kind:p.type.toUpperCase().slice(0,2), sub:p.subject||'', text:p.text||''}) });
      return arr;
    })();

    const allDay = getAllDayItemsFor(d);
    const timed = getTimedItemsFor(d);
    const rec = getRecurringFor(d);

    return `
      <div class="day ${selected?'active':''}" data-date="${key}">
        <div class="title">
          <div class="muted" style="font-size:12px">${d.toLocaleDateString(undefined,{ weekday:'short' })}${key===todayKey?' · Today':''}</div>
          <div style="font-weight:800; font-size:20px">${fmtMD(d)}</div>
        </div>
        ${selected? (`
          <ul class="tasks">
            ${dueItems.map(it=> `<li class="task"><span class="chip">${it.kind}</span><b>${it.sub}</b> · ${it.text}</li>`).join('') || '<li class="muted" style="font-size:13px">No due items</li>'}
          </ul>`)
        : ''}
        <ul class="tasks">
          ${rec.map(r=> `<li class="task"><span class="dot"></span><span class="muted" style="font-size:12px">Class</span> <b>${r.subject}</b> ${r.start}-${r.end}</li>`).join('')}
          ${timed.map(p=> `<li class="task ${p.done?'done':''}"><input type="checkbox" data-plan-done="${p.id}" ${p.done?'checked':''}/><b>${p.subject||''}</b> ${p.start}-${p.end} · ${p.text||''}</li>`).join('')}
          ${allDay.map(p=> `<li class="task ${p.done?'done':''}"><input type="checkbox" data-plan-done="${p.id}" ${p.done?'checked':''}/> ${p.text||''} ${p.subject?('· '+p.subject):''}</li>`).join('')}
        </ul>
        <div class="inline-input">
          <input type="text" placeholder="點此快速新增任務（Enter 儲存）" data-quick-input="${key}"/>
        </div>
      </div>
    `;
  }).join('');

  container.innerHTML = title + `<div class="daystrip" id="daystrip">${cards}</div>`;

  const centerSelected = (behavior='auto')=>{
    const strip = container.querySelector('#daystrip');
    const sel = strip.querySelector('.day.active');
    if(!sel) return;
    const left = sel.offsetLeft - (strip.clientWidth - sel.offsetWidth)/2;
    strip.scrollTo({ left: Math.max(0,left), behavior });
  };

  container.querySelector('#dayPrev').onclick = ()=>{ const newD=addDays(pinned,-1); store.pinnedDateISO = iso(newD); syncWeekToPinned(newD); save(); renderAll(); };
  container.querySelector('#dayNext').onclick = ()=>{ const newD=addDays(pinned,+1); store.pinnedDateISO = iso(newD); syncWeekToPinned(newD); save(); renderAll(); };
  container.querySelector('#dayToday').onclick = ()=>{ const today=new Date(); store.pinnedDateISO = iso(today); store.baseOffset = 0; save(); renderAll(); };

  const stripDiv = container.querySelector('#daystrip');
  stripDiv.addEventListener('scroll', e=>{
    const div = e.currentTarget;
    if(div.scrollLeft < 60){ stripRange.start = addDays(stripRange.start, -14); renderStripOnly(); }
    else if(div.scrollWidth - div.clientWidth - div.scrollLeft < 60){ stripRange.end = addDays(stripRange.end, +14); renderStripOnly(); }
  });

  container.querySelectorAll('.day').forEach(div=>{
    div.addEventListener('click', (e)=>{
      if(e.target.closest('input, textarea, select, button, label')) return;
      const key = div.getAttribute('data-date');
      const d = new Date(key);
      store.pinnedDateISO = d.toISOString();
      syncWeekToPinned(d);
      save(); renderAll();
    });
    div.addEventListener('dblclick', ()=>{ const key = div.getAttribute('data-date'); openTimeBlockModal(key); });
  });

  container.querySelectorAll('[data-quick-input]').forEach(inp=>{
    const stop = e=> e.stopPropagation();
    inp.addEventListener('click', stop);
    inp.addEventListener('mousedown', stop);
    inp.addEventListener('keydown', e=>{
      e.stopPropagation();
      if(e.key==='Enter'){
        const key = inp.getAttribute('data-quick-input');
        const text = inp.value.trim(); if(!text) return;
        const arr = store.dayPlans[key] || [];
        arr.push({ id:(crypto.randomUUID? crypto.randomUUID(): String(Math.random()).slice(2)), text, type:'Task', done:false, includeInCountdown:false });
        store.dayPlans[key] = arr; save(); inp.value=''; renderAll();
      }
    });
  });

  container.querySelectorAll('[data-plan-done]').forEach(chk=>{
    chk.addEventListener('click', e=> e.stopPropagation());
    chk.addEventListener('change', ()=>{
      const id = chk.getAttribute('data-plan-done');
      const key = chk.closest('.day').getAttribute('data-date');
      const arr = store.dayPlans[key] || [];
      const i = arr.findIndex(x=> x.id===id);
      if(i>=0){ arr[i].done = chk.checked; store.dayPlans[key]=arr; save(); }
    });
  });

  setTimeout(()=>centerSelected('auto'),0);
}
function renderStripOnly(){ buildStrip(document.getElementById('stripCard')); }

// --- Planner ---
function buildPlanner(container){
  const key = dateKey(new Date(store.pinnedDateISO||new Date()));
  const arr = store.dayPlans[key] || [];
  container.innerHTML = `
    <div class="header">
      <h3 style="margin:0">Day Planner · ${new Date(key).toLocaleDateString()} <span class="muted">（管理當天的所有任務；可直接編輯時間、科目與內容）</span></h3>
      <button class="btn" id="openTBFromPlanner">+ 新增時間區段</button>
    </div>
    <div id="plans"></div>
  `;
  document.getElementById('openTBFromPlanner').onclick = ()=> openTimeBlockModal(key);
  const list = container.querySelector('#plans');
  function renderList(){
    if(arr.length===0){
      list.innerHTML = `<div class="muted" style="padding:8px">此日尚無任務。你可以按上方「+ 新增時間區段」，或在上方連續日條該日的輸入框直接新增。</div>`;
      return;
    }
    list.innerHTML = arr.sort((a,b)=> (a.start||'').localeCompare(b.start||'')).map(p=> `
      <div class="rowBetween">
        <div style="display:grid; grid-template-columns:90px 90px 140px 140px 1fr 90px auto; gap:8px; align-items:center; width:100%">
          <input type="time" step="60" value="${p.start||''}" data-bind="start" data-id="${p.id}"/>
          <input type="time" step="60" value="${p.end||''}" data-bind="end" data-id="${p.id}"/>
          <select data-bind="subject" data-id="${p.id}">
            <option value="">Subject</option>
            ${SUBJECTS.map(s=> `<option ${p.subject===s?'selected':''}>${s}</option>`).join('')}
          </select>
          <select data-bind="type" data-id="${p.id}">
            ${['Task','Preview','Review','Homework','Exam','Class'].map(t=> `<option ${p.type===t?'selected':''}>${t}</option>`).join('')}
          </select>
          <input type="text" value="${p.text||''}" placeholder="What to do" data-bind="text" data-id="${p.id}"/>
          <label style="display:flex;align-items:center;gap:6px">
            <input type="checkbox" ${p.done?'checked':''} data-bind="done" data-id="${p.id}"/> Done
          </label>
          <button class="btn" data-bind="del" data-id="${p.id}">Delete</button>
        </div>
      </div>
    `).join('');

    list.querySelectorAll('[data-bind]').forEach(el=>{
      const id = el.getAttribute('data-id');
      el.addEventListener('change', ()=>{
        const idx = arr.findIndex(x=> x.id===id); if(idx<0) return;
        const b = arr[idx];
        switch(el.getAttribute('data-bind')){
          case 'start': b.start = el.value || undefined; break;
          case 'end': b.end = el.value || undefined; break;
          case 'subject': b.subject = el.value || ''; break;
          case 'type': b.type = el.value || 'Task'; break;
          case 'text': b.text = el.value || ''; break;
          case 'done': b.done = el.checked; break;
          case 'del': arr.splice(idx,1); break;
        }
        store.dayPlans[key] = arr; save(); renderList(); renderStripOnly();
      });
    });
  }
  renderList();
}

// --- Countdown panels ---
function buildDuePanels(){
  const pastEl = document.getElementById('duePast');
  const next7El = document.getElementById('dueNext7');
  const farEl = document.getElementById('dueFar');
  const today = startOfDay(new Date());
  const minus14 = addDays(today,-14), plus6 = addDays(today,6), plus13 = addDays(today,13);

  const pastList = [];     // 過去14天（含 recurring）
  const next7List = [];    // 未來7天（含 recurring）
  const farList = [];      // 之後一週（不含 recurring，只含倒數任務）

  // 生成 recurring 的近窗項目（過去14 & 未來7）
  for(let d=new Date(minus14); d<=plus6; d=addDays(d,1)){
    const weekday = d.getDay();
    (store.recurring||[]).forEach(r=>{
      if(r.weekday!==weekday) return;
      const n = ensureNote(iso(weekStartOf(d)), r.subject);
      const hw = (n.homework&&n.homework[0]) || {text:'', done:false};
      const ex = (n.exams&&n.exams[0]) || {text:'', done:false};
      const ls = (n.lessons&&n.lessons[0]) || {reviews:[false,false,false]};
      const allDone = !!hw.done && !!ex.done && (ls.reviews||[]).every(Boolean);
      if(allDone) return;
      const item = {
        date:new Date(d),
        subject:r.subject, // 使用完整科目名稱
        hwText: hw.text||'', exText: ex.text||'',
        hwDone: !!hw.done, exDone: !!ex.done,
        rev: (ls.reviews||[false,false,false]).slice(),
        weekISO: iso(weekStartOf(d)),
        kind:'CLASS'
      };
      if(d<today) pastList.push(item); else next7List.push(item);
    });
  }

  // 單日倒數任務：next7 內與 far 區間（>7 且 ≤14），只使用 includeInCountdown 的日計畫
  for(const [key, arr] of Object.entries(store.dayPlans)){
    const d = new Date(key);
    arr.forEach(p=>{
      if(!p.includeInCountdown) return;
      const base = { date:d, subject:p.subject||'', title:`${p.subject||''} ${p.type}: ${p.text||''}`.trim(), kind:p.type.toUpperCase() };
      if(d>=today && d<=plus6) next7List.push(base);
      else if(d>plus6 && d<=plus13) farList.push(base);
      else if(d<today && d>=minus14) pastList.push(base);
    });
  }

  // 排序
  pastList.sort((a,b)=> b.date-a.date);    // 過去：新的在上
  next7List.sort((a,b)=> a.date-b.date);   // 未來：越近越上
  farList.sort((a,b)=> a.date-b.date);     // 長期：越近越上

  // Render helpers
  function whenBadge(date){
    const days = Math.round((startOfDay(date) - today)/DAY);
    if(days===0) return '<span class="badge accent">TODAY</span>';
    return days>0? `<span class="badge">D-${days}</span>` : `<span class="badge">D+${Math.abs(days)}</span>`;
  }
  function rowDue(it){
    if(it.kind==='CLASS'){
      const hwBox = `<label class=\"due-label\"><input type=\"checkbox\" data-ctoggle=\"hw\" data-week=\"${it.weekISO}\" data-subject=\"${it.subject}\" ${it.hwDone?'checked':''}/> <span class=\"wrap\">hw${it.hwText?': '+it.hwText:''}</span></label>`;
      const exBox = `<label class=\"due-label\"><input type=\"checkbox\" data-ctoggle=\"ex\" data-week=\"${it.weekISO}\" data-subject=\"${it.subject}\" ${it.exDone?'checked':''}/> <span class=\"wrap\">T${it.exText?': '+it.exText:''}</span></label>`;
      const rBoxes = [0,1,2].map(i=> `<label class=\"due-label\"><input type=\"checkbox\" data-ctoggle=\"r${i}\" data-week=\"${it.weekISO}\" data-subject=\"${it.subject}\" ${it.rev[i]?'checked':''}/> <span>R${i+1}</span></label>`).join('');
      return `<div class=\"rowBetween\"><div class=\"due-left\"><div class=\"due-line\"><div style=\"font-weight:800\">${it.subject}</div>${hwBox}${exBox}</div><div class=\"due-line\">${rBoxes}</div></div>${whenBadge(it.date)}</div>`;
    }
    return `<div class=\"rowBetween\"><div class=\"due-left wrap\">${it.title}</div>${whenBadge(it.date)}</div>`;
  }

  // Render columns
  pastEl.innerHTML = `
    <h3 style="margin:0 0 8px 0" class="badge accent">過去 14 天</h3>
    ${pastList.length? pastList.map(rowDue).join(''): '<div class="muted">近兩週內沒有需要補的項目</div>'}
  `;
  next7El.innerHTML = `
    <h3 style="margin:0 0 8px 0" class="badge accent">未來 7 天</h3>
    ${next7List.length? next7List.map(rowDue).join(''): '<div class="muted">未來 7 天沒有到期項目</div>'}
  `;
  farEl.innerHTML = `
    <h3 style="margin:0 0 8px 0" class="badge accent">倒數 · 一週以外（8–14 天）</h3>
    ${farList.length? farList.map(it=> `<div class=\"rowBetween\"><div style=\"font-weight:700\">${it.title}</div>${whenBadge(it.date)}</div>`).join(''): '<div class="muted">目前沒有一週以外的倒數項目</div>'}
  `;

  // 只在 past/next7 欄位掛連動（far 區不含 recurring，也不需要 R1~R3 連動）
  [pastEl, next7El].forEach(root=>{
    root.querySelectorAll('[data-ctoggle]').forEach(chk=>{
      chk.addEventListener('change', ()=>{
        const weekISO = chk.getAttribute('data-week');
        const subject = chk.getAttribute('data-subject');
        const type = chk.getAttribute('data-ctoggle');
        const n = ensureNote(weekISO, subject);
        if(type==='hw'){
          if(!n.homework||n.homework.length===0) n.homework=[{id:(crypto.randomUUID? crypto.randomUUID(): String(Math.random()).slice(2)), text:'', done:false}];
          n.homework[0].done = chk.checked;
        }else if(type==='ex'){
          if(!n.exams||n.exams.length===0) n.exams=[{id:(crypto.randomUUID? crypto.randomUUID(): String(Math.random()).slice(2)), text:'', done:false}];
          n.exams[0].done = chk.checked;
        }else if(type && type.startsWith('r')){
          const idx = Number(type.slice(1));
          if(!n.lessons||n.lessons.length===0) n.lessons=[{id:(crypto.randomUUID? crypto.randomUUID(): String(Math.random()).slice(2)), text:'', reviews:[false,false,false], reviewTs:[null,null,null]}];
          n.lessons[0].reviews[idx] = chk.checked;
        }
        save(); buildDuePanels(); mountWeeks();
      });
    });
  });
}

// --- Modals ---
function openTimeBlockModal(dateKeyStr){
  const m = document.getElementById('modalTB'); m.style.display='flex';
  const d = document.getElementById('tbDate'); d.value = dateKeyStr;
  const s = document.getElementById('tbSubject'); s.innerHTML = `<option value="">(Subject)</option>` + SUBJECTS.map(x=> `<option>${x}</option>`).join('');
  document.getElementById('tbText').value=''; document.getElementById('tbType').value='Task'; document.getElementById('tbCountdownChk').checked=false;
  document.getElementById('tbStart').value='09:00'; document.getElementById('tbEnd').value='10:00';
  const close = ()=> m.style.display='none';
  document.getElementById('tbCancel').onclick = close;
  document.getElementById('tbSave').onclick = ()=>{
    const key = d.value; if(!key){ alert('請選日期'); return }
    const arr = store.dayPlans[key] || [];
    arr.push({
      id:(crypto.randomUUID? crypto.randomUUID(): String(Math.random()).slice(2)),
      start: document.getElementById('tbStart').value,
      end: document.getElementById('tbEnd').value,
      subject: document.getElementById('tbSubject').value || '',
      type: document.getElementById('tbType').value || 'Task',
      text: document.getElementById('tbText').value || '',
      includeInCountdown: document.getElementById('tbCountdownChk').checked,
      done:false
    });
    store.dayPlans[key] = arr; save(); close(); renderAll();
  };
}

function openRecurringModal(){
  const m = document.getElementById('modalRecurring'); m.style.display='flex';
  const list = document.getElementById('recList');
  const s = document.getElementById('recSubject'); s.innerHTML = SUBJECTS.map(x=> `<option>${x}</option>`).join('');
  function render(){
    list.innerHTML = (store.recurring||[]).map(r=> `
      <div class="rowBetween">
        <div><b>${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][r.weekday]}</b> · ${r.subject} ${r.start}-${r.end}</div>
        <button class="btn" data-del="${r.id}">Delete</button>
      </div>
    `).join('') || '<div class="muted">尚未設定</div>';
    list.querySelectorAll('[data-del]').forEach(btn=> btn.onclick = ()=>{
      const id = btn.getAttribute('data-del');
      store.recurring = store.recurring.filter(x=> x.id!==id); save(); render(); renderStripOnly();
    });
  }
  render();
  document.getElementById('recClose').onclick = ()=> m.style.display='none';
  document.getElementById('recAdd').onclick = ()=>{
    const wd = Number(document.getElementById('recWeekday').value);
    const subj = document.getElementById('recSubject').value;
    const st = document.getElementById('recStart').value;
    const en = document.getElementById('recEnd').value;
    store.recurring.push({ id:(crypto.randomUUID? crypto.randomUUID(): String(Math.random()).slice(2)), weekday:wd, subject:subj, start:st, end:en });
    save(); render(); renderStripOnly();
  };
}

function openQuickAddModal(){
  const m = document.getElementById('modalQuick'); m.style.display='flex';
  const s = document.getElementById('qaSubject'); s.innerHTML = `<option value="">(Subject)</option>` + SUBJECTS.map(x=> `<option>${x}</option>`).join('');
  document.getElementById('qaDate').value = dateKey(new Date(store.pinnedDateISO));
  document.getElementById('qaType').value = 'Task';
  document.getElementById('qaCountdownChk').checked = false;
  document.getElementById('qaText').value = '';
  const close = ()=> m.style.display='none';
  document.getElementById('qaCancel').onclick = close;
  document.getElementById('qaSave').onclick = ()=>{
    const key = document.getElementById('qaDate').value; if(!key){ alert('請選日期'); return }
    const arr = store.dayPlans[key] || [];
    arr.push({
      id:(crypto.randomUUID? crypto.randomUUID(): String(Math.random()).slice(2)),
      text: document.getElementById('qaText').value || '',
      subject: document.getElementById('qaSubject').value || '',
      type: document.getElementById('qaType').value || 'Task',
      includeInCountdown: document.getElementById('qaCountdownChk').checked,
      done:false
    });
    store.dayPlans[key] = arr; save(); close(); renderAll();
  };
}

// --- Mount & sync ---
function mountWeeks(){
  renderWeekBlock(document.getElementById('thisWeek'), 'This Week', weekStartFromBase(0));
  renderWeekBlock(document.getElementById('nextWeek'), 'Next Week', weekStartFromBase(1));
}

function renderAll(){
  mountWeeks();
  buildStrip(document.getElementById('stripCard'));
  buildDuePanels();
  buildPlanner(document.getElementById('planner'));
}

document.getElementById('jumpBtn').onclick = ()=>{
  const v = document.getElementById('jumpDate').value; if(!v) return;
  const d = new Date(v);
  store.pinnedDateISO = d.toISOString();
  syncWeekToPinned(d);
  save(); renderAll();
};
document.getElementById('openRecurring').onclick = openRecurringModal;
document.getElementById('openQuickAdd').onclick = openQuickAddModal;

// 點擊遮罩關閉
document.querySelectorAll('.modal').forEach(m=> m.addEventListener('click', e=>{ if(e.target===m) m.style.display='none' }));

renderAll();

// 讓 This/Next Week 跳到選中週
function syncWeekToPinned(d){
  const baseW = weekStartOf(new Date());
  const selW = weekStartOf(d);
  const weeks = Math.round((selW - baseW)/(7*DAY));
  store.baseOffset = weeks;
}

// --- Self-tests (basic & extended) ---
(function runSelfTests(){
  const tests = [];
  const assert = (name, cond)=> tests.push({ test: name, pass: !!cond });
  try {
    // basic
    assert('dateKey formats 2025-08-09', dateKey(new Date('2025-08-09'))==='2025-08-09');

    // smoke
    try { renderAll(); assert('renderAll invokes without error', true); } catch(e){ assert('renderAll invokes without error', false); }

    // Countdown layout: three columns exist
    assert('duePast exists', !!document.getElementById('duePast'));
    assert('dueNext7 exists', !!document.getElementById('dueNext7'));
    assert('dueFar exists', !!document.getElementById('dueFar'));

    // Titles
    const titles = document.querySelectorAll('.card h3.badge.accent');
    assert('accent titles >=3', titles.length>=3);

    // Long-term excludes recurring R checkboxes
    const farHasToggle = !!document.querySelector('#dueFar [data-ctoggle]');
    assert('far panel has no recurring toggles', !farHasToggle);
  } catch (e) {
    assert('self-test runtime error', false);
  }
  console.table(tests);
})();
</script>
</body>
</html>
